+++
category = "Hacking"
tags = ["Router"]
+++
# 从零开始配置路由器
这是一个鸽了非常非常久的项目，长期以来我一直想要一套完全自主可控的网络环境，我希望能实现以下目标：
- [ ] 让所有设备在同一个 WireGuard 网段中，使所有的设备无论在什么环境下都可以自由互相访问
- [ ] 自动分流（私有内网、校园网、国内、国外）
- [ ] 基于 MITM 的广告拦截和用户脚本

这些想法如果只是在个别设备上实现其实相对而言比较容易，首先我已经有一台阿里云服务器用作 WireGuard 的公网节点，我的电脑只需分别配置 WireGuard、V2Ray（X-Ray） 和 AdGuard 即可实现上述三个目标，甚至如果操作得当只需要配置 ShadowRocket 或 Surge 这样的软件就可以实现所有的目标。

但这种方式的缺点就在于必须每个设备单独配置，而且（在不同的平台上）使用较多的软件组合也不利于配置的同步，此外一些设备配置 WireGuard 和用户脚本时更加复杂，这样的配置显然不能算理想。因此我的计划是使用一台 ArchLinux 的主机作为路由器，为接入该路由器的所有设备分配私有内网 IP，并且通过正确配置路由表内外部设备能够通过 WireGuard 互相访问，使所有的设备（在外部的通过 WireGuard）的流量都经过该路由器的过滤，这样所有的设备至多只需配置 WireGuard 即可实现上述的所有功能，而在该路由器下接入的设备则无需任何配置。

[//]: # (在发表于 Weekly 9 时应当添加 WireGuard 的背景介绍，但是此处先略去)
## 总体方案

## 使用设备
这个想法虽然很好，但所需的设备却十分刁钻：这个设备应当性能足以运行 ArchLinux 并基于 KVM 运行一个 Windows 系统，但是性能应当尽量不要太高，需要将能耗控制在适当的范围内；同时这个设备应当具有多网口和较好的无线天线，此外如果具有少量的扩展性则可以更好地充当一个影音终端。

许多天前我在摸鱼的时候发现了这样的一个精准命中需求的设备：[Maxtang 大唐TRI系列台式NUC迷你组装电脑英特尔12代四核双网口商务高速固态无风扇主机 【2.5G四网版】J6412 准系统](https://item.jd.com/10072905428786.html)，搭载 Intel J6412 处理器、四网口和 Wi-Fi 6 天线，甚至还支持通过 Sim 卡上网，基本满足了我的所有设想，因此我立即决定先买下来以备日后摸鱼。

我另外购买了一条光威的 8GB DDR4 内存，以及一条金储星的 256GB M.2 SATA 硬盘（要不是因为必须用 M.2 SATA 硬盘我还真没听说过这个品牌）。至此一切准备就绪，开始进入第一步。

## 安装系统
这里一半是为了做教程，一半是为了防止我忘记了自己读过的文档，尽量做一个详细的记录。

首先通过 [TUNA 源](https://mirrors.tuna.tsinghua.edu.cn/archlinux/iso) 下载最新的 ArchLinux 镜像：
```bash
wget https://mirrors.tuna.tsinghua.edu.cn/archlinux/iso/2023.09.01/archlinux-2023.09.01-x86_64.iso
```

这里我选择通过 USB 安装系统，